pipeline {
    agent any
	parameters {
        choice choices: ['LoadTest', 'StressTest', 'EnduranceTest', 'BaselineTest', 'LoadTest_MainFlows', 'ScriptVerification_SmokeTest'], description: 'Type of Test To Be Executed', name: 'Type_of_API_test'
        string defaultValue: '1', description: 'Number of virtual users', name: 'VU1'
        string defaultValue: '60', description: 'Duration(seconds)', name: 'DURATION'
	string defaultValue: '1', description: 'Iterations', name: 'ITERATIONS'
	choice(choices: ['test5.js', 'test4.js'], description: 'Select a test', name: 'scenario')
		}
		
       stages {
        stage('Verify k6') {
            steps {
                bat 'k6 version'
            }
        }
	     stage('Run k6 test') {
            steps {
                 // Run k6 and generate JSON output
                    bat 'k6 run --vus %VU1% --duration %DURATION%s --out influxdb=http:\\localhost:8086\\mydb K6_scenarios\\.idea\\%scenario%'
		 //   bat "k6 run --vus ${VU1} --duration ${DURATION}s K6_scenarios\\.idea\\${SCENARIO}"
                //    bat 'k6 run --vus %VU1% --duration %DURATION%s K6_scenarios\\.idea\\test4.js'
                    // Generate HTML report from JSON
                //   bat 'k6 report -o summaryy.html summaryy.json'
            }
        }
		stage('Publish HTML Report') {
            steps {
                script {
                // reportName variable
                def reportName = params.Type_of_API_test
                // Thread variable
                def VU1 = params.VU1
                // Get the current timestamp in milliseconds
                def timestamp = currentBuild.getTimeInMillis()
                // Format the timestamp into a human-readable date
                def formattedTimestamp = new Date(timestamp).format('yyyy-MM-dd HH:mm:ss')
                 // Publish the HTML report
                publishHTML(target: [
                    allowMissing: true,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: '.',
                    reportFiles: 'summary.html', // Specify the main HTML file to display
                    reportName: "${formattedTimestamp} ${reportName} HTML Report with ${VU1} users"
                ])
            }
            }
        }
    }
}
